{% extends 'dashboard.html' %}

{% block dashboard_content %}
    <div class="subpage-content">
<div class="container">
  <h1 class="title is-1">{{ project_name }} Code Quality Report - {{ report_date }}</h1>
  <p>Generated by {{ report_generator }}</p>

  <!-- Cohesion section -->
  <section class="section">
    <h2 class="title is-4 has-text-warning">Code file structure</h2>
    <p class="subtitle is-6 has-text-primary">This section shows the file structure of your code and how the different files and classes are connected. It can help you understand how the different parts of your code fit together and identify any potential issues with your code organization.</p>
    {% if not report.cohesion_result[0].classes %}
      <p>{{ report.cohesion_text }}</p>
    {% else %}
      <p>Issues found:</p>
      <ul>
        {% for class in report.cohesion_result[0].classes %}
          <li>{{ class.name }}
              <ul class="ml-4">
                {% for method in class.methods %}
                {% if method.cohesion_as_float < 50 %}
                <li>{{ method.name }} {{method.cohesion}} {{method.cohesion_percentage}}
                  <ul class="ml-4">
                    {% for vars in method.variables %}

                      {% if not vars.cohesive_use%}
                        <li class="has-text-danger">{{vars.name}}</li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </li>
                {% endif %}
                {% endfor %}
              </ul>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </section>

  <!-- Prospector section -->
  <section class="section">
    <h2 class="title is-4 has-text-warning">Code quality issues</h2>
    <p class="subtitle is-6 has-text-primary">This section highlights any potential issues with the quality of your code, such as code complexity, unused variables, and other common problems. It can help you identify areas of your code that may need improvement and suggest ways to make your code more maintainable and readable.</p>
    <p>Time taken: {{ report.prospector_result.summary.time_taken }}</p>
    <p>Number of modules analyzed: {{ report.prospector_result.summary.module_count }}</p>
    <p>Number of issues found: {{ report.prospector_result.summary.issue_count }}</p>

    {% for issue_group in report.prospector_result.issues %}
      {% set severity = 'minor' if issue_group.number_of_issues < 3 else 'medium' if issue_group.number_of_issues < 6 else 'major' %}
      <div class="notification is-{{ severity }}">
        <p>Module: {{ issue_group.module_name }}</p>
        <p>Number of issues: {{ issue_group.number_of_issues }}</p>
        <ul>
          {% for issue in issue_group.issues %}
            <li>{{ issue.message }} ({{ issue.tool }})</li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  </section>

  <!-- Radon section -->
  <section class="section">
    <div class="container">
      <h2 class="title is-4 has-text-warning">Code complexity</h2>
      <p class="subtitle is-6 has-text-primary">This section provides information on the complexity of your code, such as the number of lines of code, the number of functions, and the complexity of each function. It can help you identify areas of your code that may be overly complex and suggest ways to simplify your code.</p>
      <div class="columns">
        <div class="column is-half">
          <h3 class="title is-3">Summary</h3>
          <p>{{ report.radon_text|safe }}</p>
        </div>
        <div class="column is-half">
          <h3 class="title is-3">Functions complexity</h3>
          <canvas id="radon-chart" width="400px" height="400px"></canvas>
        </div>
      </div>
    </div>
  </section>

<!-- Flake8 section -->
<div class="section">
  <h2 class="subtitle is-4 has-text-warning">Code style issues</h2>
  <p class="subtitle is-6 has-text-primary">This section highlights any potential issues with the style of your code, such as indentation, variable naming, and other common style problems. It can help you make your code more consistent and easier to read, which can improve the maintainability of your code.</p>
  {% if report.flake8_result %}
    {% for issue_type in report.flake8_result %}
      {% if issue_type.issues %}
        <div class="card flake8-card">
          {% if 'Bugs' in issue_type.name or 'Errors' in issue_type.name %}
            <header class="card-header has-background-danger">
          {% else %}
            <header class="card-header has-background-info">
          {% endif %}
            <p class="card-header-title">
              {{ issue_type.name }}
            </p>
          </header>
          <div class="card-content">
            <div class="content">
              <table class="table is-striped is-fullwidth">
                <thead>
                  <tr>
                    <th>Module</th>
                    <th>Line</th>
                    <th>Column</th>
                    <th>Code</th>
                    <th>Message</th>
                  </tr>
                </thead>
                <tbody>
                  {% for issue in issue_type.issues %}
                    <tr>
                      <td>{{ issue.module }}</td>
                      <td>{{ issue.line }}</td>
                      <td>{{ issue.col }}</td>
                      <td>{{ issue.code }}</td>
                      <td>{{ issue.message }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

        </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p>No Flake8 issues found.</p>
  {% endif %}
</div>

<!-- Pytest section -->
<div class="section">
  <h2 class="subtitle is-4 has-text-warning">Code testing results</h2>
  <p class="subtitle is-6 has-text-primary"> This section shows the results of running tests on your code, including the number of tests run, the number of tests that passed and failed, and the percentage of tests that passed. It can help you identify any issues with your code that might be causing tests to fail and ensure that your code is working as expected.</p>
  <p>Test run: {{ report.pytest_result.test_run }}</p>
  <p>Tests passed: {{ report.pytest_result.test_passed }}</p>
  <p>Tests failed: {{ report.pytest_result.test_failed }}</p>
  {% if report.pytest_result.failed_tests %}
    <h3 class="subtitle is-6">Failed tests</h3>
    <table class="table is-striped is-fullwidth">
      <thead>
        <tr>
          <th>Module</th>
          <th>Test</th>
          <th>Line</th>
          <th>Message</th>
        </tr>
      </thead>
      <tbody>
        {% for test in report.pytest_result.failed_tests %}
          <tr>
            <td>{{ test.module }}</td>
            <td>{{ test.name }}</td>
            <td>{{ test.line }}</td>
            <td>{{ test.message }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
  <p>Percentage of tests passed: {{ report.pytest_result.percentage_passed }}%</p>
  {% if report.pytest_result.total_coverage.test_run > 0 %}
    <p>Total coverage: {{ report.pytest_result.total_coverage.percentage_passed }}%</p>
  {% endif %}
</div>

</div>
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Get the data for the chart
  const data = {
    labels: [],
    datasets: [
      {
        label: 'Function complexity',
        backgroundColor: 'rgba(0, 123, 255, 0.5)',
        borderColor: 'rgb(0, 123, 255)',
        data: []
      }
    ]
  };
  const functions = {{ report.radon_result[0].radon_metrics.function_breakdown|tojson }};
  for (const func of functions) {
    data.labels.push(func.function_name);
    data.datasets[0].data.push(func.complexity);
  }

  // Create the chart
  const chart = new Chart('radon-chart', {
    type: 'bar',
    data: data,
options: {
  title: {
    display: true,
    text: 'Radon Metrics',
    fontSize: 18
  },
  scales: {
    yAxes: [{
      ticks: {
        min: 0,
        max: 25
      },
      scaleLabel: {
        display: true,
        labelString: 'Complexity Score',
        fontSize: 16
      }
    }],
    xAxes: [{
      scaleLabel: {
        display: true,
        labelString: 'Function',
        fontSize: 16
      }
    }]
  }
}
  });
</script>

{% endblock %}
